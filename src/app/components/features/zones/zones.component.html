<section class="zones">
  <h2 class="title">
    <svg class="title-icon" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"></path>
    </svg>
    <span>Zonas</span>
  </h2>

  <form class="filters" autocomplete="off" (submit)="$event.preventDefault()">
    <div class="field" style="position: relative;">
      <label>País</label>
      <input 
        type="search" 
        [ngModel]="filters.country" 
        [ngModelOptions]="{standalone: true}"
        (ngModelChange)="onCountryInput($event)" 
        (focus)="preventNativeAutofill($event); showCountryDropdown = countrySuggestions.length > 0"
        name="ignore-country" id="ignore-country" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" inputmode="search"
        placeholder="Escribí para buscar países..." />
      <div 
        class="typeahead-dropdown" 
        *ngIf="showCountryDropdown"
        (mouseleave)="showCountryDropdown = false"
      >
        <button 
          type="button" 
          class="typeahead-item" 
          *ngFor="let c of countrySuggestions" 
          (click)="onSelectCountry(c)"
        >
          {{ c.name }}
        </button>
        <div class="typeahead-empty" *ngIf="countrySuggestions.length === 0">Sin resultados</div>
      </div>
    </div>
    <div class="field" style="position: relative;">
      <label>Provincia</label>
      <input 
        type="search" 
        [disabled]="!selectedCountryId || statesAll.length === 0"
        [ngModel]="filters.province"
        [ngModelOptions]="{standalone: true}"
        (ngModelChange)="onProvinceInput($event)"
        (focus)="preventNativeAutofill($event); showProvinceDropdown = provinceSuggestions.length > 0"
        name="ignore-province" id="ignore-province" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" inputmode="search"
        [placeholder]="(!selectedCountryId ? 'Seleccioná un país primero' : (statesAll.length === 0 ? 'Cargando provincias...' : 'Escribí para buscar provincias...'))" />
      <div 
        class="typeahead-dropdown" 
        *ngIf="showProvinceDropdown"
        (mouseleave)="showProvinceDropdown = false"
      >
        <button 
          type="button" 
          class="typeahead-item" 
          *ngFor="let s of provinceSuggestions" 
          (click)="onSelectProvince(s)"
        >
          {{ s.name }}
        </button>
        <div class="typeahead-empty" *ngIf="provinceSuggestions.length === 0">Sin resultados</div>
      </div>
    </div>
    <div class="field" style="position: relative;">
      <label>Localidad</label>
      <input 
        type="search"
        [disabled]="!filters.province"
        [ngModel]="filters.city"
        [ngModelOptions]="{standalone: true}"
        (ngModelChange)="onLocalityInput($event)"
        (focus)="preventNativeAutofill($event); showLocalityDropdown = localitySuggestions.length > 0"
        name="ignore-locality" id="ignore-locality" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" inputmode="search"
        [placeholder]="(!filters.province ? 'Seleccioná una provincia primero' : (localitiesAll.length === 0 ? 'Cargando localidades...' : 'Escribí para buscar localidades...'))" />
      <div 
        class="typeahead-dropdown" 
        *ngIf="showLocalityDropdown"
        (mouseleave)="showLocalityDropdown = false"
      >
        <button 
          type="button" 
          class="typeahead-item" 
          *ngFor="let l of localitySuggestions" 
          (click)="onSelectLocality(l)"
        >
          {{ l.name }}
        </button>
        <div class="typeahead-empty" *ngIf="localitySuggestions.length === 0">Sin resultados</div>
      </div>
    </div>
    <div class="field span-2">
      <label>Código Postal</label>
      <input 
        type="text" 
        [(ngModel)]="filters.postal_code" 
        [ngModelOptions]="{standalone: true}"
        name="ignore-postal-code" id="ignore-postal-code" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false" inputmode="numeric"
        placeholder="Ingrese código postal" 
      />
    </div>
    <div class="actions">
      <button class="btn secondary" (click)="onClearFilters()" [disabled]="loading">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
        </svg>
        <span>Limpiar Filtros</span>
      </button>
      <button class="btn primary" (click)="onSearch()" [disabled]="loading">
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true" *ngIf="!loading">
          <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"></path>
        </svg>
        <svg class="icon loading" viewBox="0 0 24 24" aria-hidden="true" *ngIf="loading">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"></path>
        </svg>
        <span>{{ loading ? 'Buscando...' : 'Buscar' }}</span>
      </button>
    </div>
  </form>

  <div class="table-card">
    <div class="table-header" *ngIf="zipResults.length > 0 && !loading">
      <span class="results-count">{{ zipResults.length }} localidad{{ zipResults.length !== 1 ? 'es' : '' }} encontrada{{ zipResults.length !== 1 ? 's' : '' }}</span>
    </div>
    
    <table class="table">
      <thead>
        <tr>
          <th>ID Localidad</th>
          <th>Localidad</th>
          <th>Provincia / Estado</th>
          <th>País</th>
          <th>CP</th>
          
        </tr>
      </thead>
      <tbody>
        <!-- Skeleton rows while loading -->
        <tr *ngIf="loading" class="skeleton-row" aria-hidden="true">
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
        </tr>
        <tr *ngIf="loading" class="skeleton-row" aria-hidden="true">
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
        </tr>
        <tr *ngIf="loading" class="skeleton-row" aria-hidden="true">
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
          <td><div class="skeleton skeleton-text"></div></td>
        </tr>

        <!-- Result rows from zip/locality search -->
        <tr *ngFor="let r of zipResults">
          <td>{{ r.locality?.id || r.locality_id }}</td>
          <td>{{ r.locality?.name || filters.city }}</td>
          <td>{{ filters.province }}</td>
          <td>{{ filters.country }}</td>
          <td>{{ r.code }}</td>
        </tr>
      </tbody>
    </table>

    <div class="empty-state" *ngIf="zipResults.length === 0 && !loading">
      <svg class="empty-icon" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5S10.62 6.5 12 6.5s2.5 1.12 2.5 2.5S13.38 11.5 12 11.5z"></path>
      </svg>
      <h3>No se encontraron zonas</h3>
      <p>Intenta ajustar los filtros de búsqueda o agrega una nueva zona.</p>
    </div>

    
  </div>
</section>
